<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Warehouse Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <style>
        :root {
            --bg: #0f172a;
            --sidebar: #020617;
            --card: #111827;
            --accent: #22c55e;
            --warning: #f59e0b;
            --text: #e5e7eb;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: Inter, sans-serif;
        }

        body {
            background: var(--bg);
            color: var(--text);
        }

        .app {
            display: grid;
            grid-template-columns: 240px 1fr;
            min-height: 100vh;
        }

        /* SIDEBAR */
        .sidebar {
            background: var(--sidebar);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .sidebar h2 {
            color: var(--accent);
        }

        .sidebar a {
            color: var(--text);
            text-decoration: none;
            padding: 10px;
            border-radius: 8px;
            display: block;
        }

        .sidebar a:hover {
            background: #111827;
        }

        .menu-item>a {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .submenu,
        .subsubmenu {
            display: none;
            margin-top: 6px;
            margin-left: 10px;
        }

        .submenu a,
        .subsubmenu a {
            display: block;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
        }

        .submenu a:hover,
        .subsubmenu a:hover {
            background: #111827;
        }

        .subsubmenu {
            margin-left: 14px;
            border-left: 2px solid #1f2937;
            padding-left: 10px;
        }

        .arrow {
            font-size: 12px;
            transition: transform 0.2s ease;
        }

        .menu-open>a .arrow {
            transform: rotate(180deg);
        }

        /* MAIN CONTENT */
        .main-content {
            padding: 20px;
        }

        .kpis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .kpi {
            background: #020617;
            padding: 18px;
            border-radius: 14px;
            text-align: center;
        }

        .kpi .value {
            font-size: 28px;
            font-weight: 700;
            margin-top: 6px;
        }

        .pnc_warehouse {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .card {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
        }

        th,
        td {
            border: 1px solid #333;
            padding: 8px;
            text-align: center;
        }

        th {
            background: #111827;
            color: var(--accent);
        }

        input {
            width: 100%;
            padding: 8px;
            border-radius: 8px;
            background: #020617;
            border: 1px solid #1f2937;
            color: white;
            margin-bottom: 8px;
        }

        .btn {
            background: #22c55e;
            border: none;
            color: #020617;
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn:hover {
            opacity: .85;
        }

        /* Date inputs side by side & small */
        .date-inline {
            display: flex;
            gap: 6px;
            align-items: center;
            width: 350px
        }

        .date-inline input[type="date"] {
            width: 140px;
            padding: 6px 8px;
            font-size: 13px;
            margin-bottom: 0;
            cursor: pointer;
        }

        /* Focus / select effect */
        .date-inline input[type="date"]:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.35);
        }

        #packingSection {
            grid-template-columns: repeat(3, 1fr);
        }

        @media (max-width:1024px) {
            .pnc_warehouse {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="app">

        <!-- Sidebar -->
        <aside class="sidebar">
            <h2>MYholdal</h2>
   <a href="index.html"> <button class="btn" onclick="goHome()">Dashboard</button></a>
            <div class="menu-item">
                <a href="#" onclick="toggleMenu('warehousesMenu')">
                    <i class="fa-solid fa-boxes-stacked"></i> Warehouses
                    <i class="fa-solid fa-chevron-down arrow"></i>
                </a>

                <div id="warehousesMenu" class="submenu">

                    <!-- P&C -->
                    <div class="submenu-item">
                        <a href="#" onclick="toggleMenu('pcMenu')">P&amp;C</a>
                        <div id="pcMenu" class="subsubmenu">
                            <a href="#" onclick="selectWarehouse('p&c')">MyHoldal</a>
                            <a href="#">Return</a>
                            <a href="#">KPI</a>
                        </div>
                    </div>

                    <!-- Pharma -->
                    <div class="submenu-item">
                        <a href="#" onclick="toggleMenu('pharmaMenu')">Pharma</a>
                        <div id="pharmaMenu" class="subsubmenu">
                            <a href="#" onclick="selectWarehouse('pharma')">MyHoldal</a>
                            <a href="#">Return</a>
                            <a href="#">KPI</a>
                        </div>
                    </div>

                    <!-- Retail -->
                    <div class="submenu-item">
                        <a href="#" onclick="toggleMenu('retailMenu')">Retail</a>
                        <div id="retailMenu" class="subsubmenu">
                            <a href="#" onclick="selectWarehouse('retail')">MyHoldal</a>
                            <a href="#">Return</a>
                            <a href="#">KPI</a>
                        </div>
                    </div>

                    <!-- L’Oréal Lux -->
                    <div class="submenu-item">
                        <a href="#" onclick="toggleMenu('lorealMenu')">L’Oréal
                            Lux</a>
                        <div id="lorealMenu" class="subsubmenu">
                            <a href="#" onclick="selectWarehouse('loreallux')">MyHoldal</a>
                            <a href="#">Return</a>
                            <a href="#">KPI</a>
                        </div>
                    </div>

                    <!-- Beesline -->
                    <div class="submenu-item">
                        <a href="#" onclick="toggleMenu('beeslineMenu')">Beesline</a>
                        <div id="beeslineMenu" class="subsubmenu">
                            <a href="#" onclick="selectWarehouse('beesline')">MyHoldal</a>
                            <a href="#">Return</a>
                            <a href="#">KPI</a>
                        </div>
                    </div>
                    <!-- Packing Station -->
                    <div class="submenu-item">
                                <a href="#" onclick="selectWarehouse('packing')">Packing Station</a>
                    </div>

                </div>
            </div>
        </aside>

        <!-- Main content -->
        <div class="main-content">
            <h2 id="currentWarehouseName" style="margin-bottom: 20px; color: #22c55e;">Warehouse:
                P&C</h2>

            <!-- KPIs -->
            <div class="kpis">
                <div class="kpi">
                    <div>Total Orders</div>
                    <div id="totalOrders" class="value">0</div>
                </div>
                <div class="kpi">
                    <div>Issued</div>
                    <div id="issuedOrders" class="value success">0</div>
                </div>
                <div class="kpi">
                    <div>Pending</div>
                    <div id="pendingOrders" class="value warning">0</div>
                </div>
                <div class="kpi">
                    <div>Avg Prep Time</div>
                    <div id="avgPrep" class="value">0 min</div>
                </div>
            </div>
            <!-- Date Filter -->
            <!-- Date Filter -->
            <div class="card" style="margin-bottom:20px;">
                <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
                    <div class="date-inline">
                        From: <input type="date" id="fromDate">
                        to: <input type="date" id="toDate">
                    </div>

                    <button onclick="applyDateFilter()" class="btn">Apply</button>

                    <!-- Three dots -->
                    <div style="position:relative;">
                        <button class="btn" onclick="toggleQuickMenu()" style="background:#374151;">⋮</button>

                        <div id="quickMenu" style="
        display:none;
        position:absolute;
        right:0;
        top:40px;
        background:#020617;
        border:1px solid #1f2937;
        border-radius:10px;
        padding:8px;
        z-index:99;
        min-width:140px;
      ">
                            <button class="btn" style="width:100%;margin-bottom:6px;"
                                onclick="quickDate('today')">Today</button>
                            <button class="btn" style="width:100%;margin-bottom:6px;"
                                onclick="quickDate('yesterday')">Yesterday</button>
                            <button class="btn" style="width:100%;margin-bottom:6px;" onclick="quickDate('week')">This
                                Week</button>
                            <button class="btn" style="width:100%;margin-bottom:6px;" onclick="quickDate('month')">This
                                Month</button>
                            <button class="btn" style="width:100%;background:#374151;"
                                onclick="quickDate('all')">All</button>
                        </div>
                    </div>

                </div>
            </div>
            <!-- Search + Tables -->
            <!-- Normal warehouses -->
            <div id="normalWarehouseSection" class="pnc_warehouse">

                <!-- Issued -->
                <div class="card">
                    <h3 style="color:#22c55e;">Issued Orders</h3>
                    <input type="text" id="issuedSearch" placeholder="Search Order #" oninput="renderIssuedTable()">
                    <div id="issuedTable"></div>
                </div>

                <!-- Pending -->
                <div class="card">
                    <h3 style="color:#f59e0b;">Pending Orders</h3>
                    <input type="text" id="pendingSearch" placeholder="Search Order # or Comment"
                        oninput="renderPendingTable()">
                    <div id="pendingTable"></div>
                </div>

            </div>

            <!-- Packing Station (SEPARATE) -->
            <div id="packingSection" class="pnc_warehouse" style="display:none;grid-template-columns:repeat(3,1fr);">

                <div class="card">
                    <h3 style="color:#22c55e;">Packed Orders</h3>
                    <div id="packedTable"></div>
                </div>

                <div class="card">
                    <h3 style="color:#f59e0b;">Waiting Packing</h3>
                    <div id="waitingPackingTable"></div>
                </div>

                <div class="card">
                    <h3 style="color:#ef4444;">Waiting Other Warehouse</h3>
                    <div id="waitingOtherTable"></div>
                </div>
  <div class="card">
    <h3 style="color:#3b82f6;">Distributed Orders</h3>
    <div id="distributedTable"></div>
  </div>
            </div>

        </div>
    </div>
    </div>

    <script>
        function checkLogin() {
            if (sessionStorage.getItem("loggedIn") === "true") {
                document.getElementById("loginSection").style.display = "none";
                document.getElementById("dashboardSection").style.display = "block";
            } else {
                document.getElementById("loginSection").style.display = "block";
                document.getElementById("dashboardSection").style.display = "none";
            }
        }

        // نفّذ عند تحميل الصفحة
        document.addEventListener("DOMContentLoaded", checkLogin);


        // نفّذ عند تحميل الصفحة


        function goHome() {
            sessionStorage.setItem("loggedIn", "true");
            checkLogin();
        }

        const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSAeWlFZdvqQqrWCq0uJKqxz6boomvVuNal1IYM1tOuoeraNE_ZW2BfYYKr3lKfmldOWOgWAXhz88Ke/pub?gid=1480729463&single=true&output=csv";
         const pharma=  "https://docs.google.com/spreadsheets/d/e/2PACX-1vSAeWlFZdvqQqrWCq0uJKqxz6boomvVuNal1IYM1tOuoeraNE_ZW2BfYYKr3lKfmldOWOgWAXhz88Ke/pub?gid=875574333&single=true&output=csv";
            const pnc="https://docs.google.com/spreadsheets/d/e/2PACX-1vSAeWlFZdvqQqrWCq0uJKqxz6boomvVuNal1IYM1tOuoeraNE_ZW2BfYYKr3lKfmldOWOgWAXhz88Ke/pub?gid=228371932&single=true&output=csv";
         const retail="https://docs.google.com/spreadsheets/d/e/2PACX-1vSAeWlFZdvqQqrWCq0uJKqxz6boomvVuNal1IYM1tOuoeraNE_ZW2BfYYKr3lKfmldOWOgWAXhz88Ke/pubhtml?gid=274206&single=true";
       const beesline="https://docs.google.com/spreadsheets/d/e/2PACX-1vSAeWlFZdvqQqrWCq0uJKqxz6boomvVuNal1IYM1tOuoeraNE_ZW2BfYYKr3lKfmldOWOgWAXhz88Ke/pubhtml?gid=1278749068&single=true";
         const lux = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSAeWlFZdvqQqrWCq0uJKqxz6boomvVuNal1IYM1tOuoeraNE_ZW2BfYYKr3lKfmldOWOgWAXhz88Ke/pubhtml?gid=884068351&single=true";
        const packing_station = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSAeWlFZdvqQqrWCq0uJKqxz6boomvVuNal1IYM1tOuoeraNE_ZW2BfYYKr3lKfmldOWOgWAXhz88Ke/pubhtml?gid=457547473&single=true";

        
        let allOrders = [];
        let currentWarehouse = "p&c";
        let issuedOrders = [];
        let pendingOrders = [];
        let packingOrders = [];
        let distributedOrders = [];
        // Normalize warehouse names
        function normalize(s) {
            if (!s) return "";
            return s
                .toLowerCase()
                .replace(/[^a-z0-9]/g, "")   // يحذف كل الرموز é ’ - ---
                .replace(/wh|pack/g, "")     // يحذف wh و pack
                .trim();
        }

        // Toggle menu
        function toggleMenu(id) {
            const el = document.getElementById(id);
            el.style.display = (el.style.display === 'block') ? 'none' : 'block';
        }

        // Parse date safely
        function parseDate(d) {
            const t = new Date(d);
            return isNaN(t) ? null : t;
        }

        // Calculate minutes difference
        function minutesDiff(a, b) {
            if (!a || !b) return 0;
            return Math.round((b - a) / 60000);
        }

        // Fetch CSV and prepare data
        fetch(sheetURL)
            .then(r => r.text())
            .then(csv => {
                const rows = Papa.parse(csv, { header: true, skipEmptyLines: true }).data;
                console.log("Rows loaded:", rows);

                const map = {};
                rows.forEach(r => {
                    const id = r["#M Order"];
                    if (!id) return;

                    if (!map[id]) {
                        map[id] = { order: id, warehouses: {} };
                    }

                    let whName = (r["Warehouse Name"] || "").trim().toLowerCase();
                    let base = whName.replace(/---pack/g, "").replace(/\s*wh/g, "").trim();
                    base = normalize(base);

                  if (!map[id].warehouses[base]) {
  map[id].warehouses[base] = {
    packed: false,
    comment: "",
    distributedBy: ""
  };
}
if (r["Distributed By"])
  map[id].warehouses[base].distributedBy =
    r["Distributed By"].toLowerCase();

                    if (r["comment"]) map[id].warehouses[base].comment = r["comment"];

                    if (whName.includes("pack")) map[id].warehouses[base].packed = true;

                    const time = parseDate(r["Order Received in WH"]);
                    if (time) {
                        const w = map[id].warehouses[base];
                        if (!w.whTime || time < w.whTime) w.whTime = time;
                    }

                    const packTime = parseDate(r["Order Received in WH"]);
                    if (whName.includes("pack") && packTime) {
                        const w = map[id].warehouses[base];
                        if (!w.packTime || packTime > w.packTime) w.packTime = packTime;
                    }
                });

                allOrders = Object.values(map);
                selectWarehouse(currentWarehouse);
            });

        function selectWarehouse(key) {

            currentWarehouse = key;
            document.getElementById("currentWarehouseName").textContent =
                "Warehouse: " + key;

            issuedOrders = [];
            pendingOrders = [];

            // ================= PACKING STATION =================
            if (key === "packing") {

                // show packing tables
                document.getElementById("packingSection").style.display = "grid";

                // hide normal warehouse tables
                document.getElementById("normalWarehouseSection").style.display = "none";

                allOrders.forEach(o => {

                    const whs = o.warehouses;
                    const whNames = Object.keys(whs);

                    let packedCount = 0;
                    const waitingWH = [];

                    whNames.forEach(wh => {
                        if (whs[wh].packed) {
                            packedCount++;
                        } else {
                            waitingWH.push(wh);
                        }
                    });

                    const totalWH = whNames.length;

                    // ===== مستودع واحد =====
                    if (totalWH === 1) {
                        const w = whs[whNames[0]];

                        if (w.packed) {
                            issuedOrders.push({
                                order: o.order,
                                packTime: w.packTime || null,
                                prep: 0,
                                comment: "Ready to distribute"
                            });
                        } else {
                            pendingOrders.push({
                                order: o.order,
                                whTime: w.whTime || null,
                                comment: "Waiting packing"
                            });
                        }
                    }

                    // ===== أكثر من مستودع =====
                    else {

                        if (packedCount === totalWH) {
                            issuedOrders.push({
                                order: o.order,
                                packTime: Object.values(whs).find(w => w.packed)?.packTime || null,
                                prep: 0,
                                comment: "Ready to distribute"
                            });
                        } else {
                            pendingOrders.push({
                                order: o.order,
                                whTime: Object.values(whs).find(w => !w.packed)?.whTime || null,
                                comment: "Waiting other warehouse: " + waitingWH.join(", ")
                            });
                        }

                    }

                });

                renderPackingTables();
                updateKPIs();
                return;
            }

            // ================= باقي المستودعات =================
            document.getElementById("packingSection").style.display = "none";
            document.getElementById("normalWarehouseSection").style.display = "grid";

            allOrders.forEach(o => {
                const whData = o.warehouses[normalize(key)];
                if (!whData) return;

                const whTime = whData.whTime || null;
                const packTime = whData.packTime || null;

                if (whData.packed) {
                    issuedOrders.push({
                        order: o.order,
                        whTime,
                        packTime: packTime || whTime,
                        prep: packTime ? minutesDiff(whTime, packTime) : 0,
                        comment: whData.comment || ""
                    });
                } else if (whTime) {
                    pendingOrders.push({
                        order: o.order,
                        whTime,
                        comment: whData.comment || ""
                    });
                }
            });

            renderIssuedTable();
            renderPendingTable();
            updateKPIs();
        }


        // Render Issued Orders Table
        function renderIssuedTable() {
            const q = document.getElementById("issuedSearch").value.toLowerCase();
            const filtered = issuedOrders.filter(o =>
                o.order.toLowerCase().includes(q) &&
                inDateRange(o.packTime)
            );
            document.getElementById("issuedTable").innerHTML = `
    <table>
        <tr>
            <th>Order #</th>
            <th>Received at Packing</th>
            <th>${currentWarehouse === "packing" ? "Distributed" : "Preparation Time (min)"}</th>
        </tr>
        ${filtered.map(o => `
            <tr>
                <td>${o.order}</td>
                <td>${o.packTime ? o.packTime.toLocaleString() : "-"}</td>
                <td>${currentWarehouse === "packing" ? o.comment : o.prep}</td>
            </tr>`).join("")}
    </table>`;
        }

        // Render Pending Orders Table
        function renderPendingTable() {
            const q = document.getElementById("pendingSearch").value.toLowerCase();
            const filtered = pendingOrders.filter(o =>
                (o.order.toLowerCase().includes(q) ||
                    o.comment.toLowerCase().includes(q)) &&
                inDateRange(o.whTime)
            );

            document.getElementById("pendingTable").innerHTML = `
    <table>
        <tr>
            <th>Order #</th>
            <th>Received at WH</th>
            <th>Comment</th>
        </tr>
        ${filtered.map(o => `
            <tr>
                <td>${o.order}</td>
                <td>${o.whTime ? o.whTime.toLocaleString() : "-"}</td>
                <td>${o.comment}</td>
            </tr>`).join("")}
    </table>`;
        }



        function renderPackingStation() {
            const packingDiv = document.getElementById("packingOrders");
            packingDiv.innerHTML = ""; // تنظيف المحتوى

            // Filter كل الـ packed orders عبر جميع المستودعات
            const packedOrders = [];
            allOrders.forEach(o => {
                for (const whKey in o.warehouses) {
                    const whData = o.warehouses[whKey];
                    if (whData.packed) {
                        // تحديد الـ distributed
                        let distributed = whData.distributed ? whData.distributed : "Ready to distribute";
                        packedOrders.push({
                            order: o.order,
                            packTime: whData.packTime,
                            distributed
                        });
                    }
                }
            });

            if (packedOrders.length === 0) {
                packingDiv.innerHTML = "<p style='padding:8px;color:#aaa;'>No packed orders yet.</p>";
                return;
            }

            // بناء جدول
            const table = document.createElement("table");
            table.innerHTML = `
        <tr>
            <th>Order #</th>
            <th>Receiving Time</th>
            <th>Distributed</th>
        </tr>
    `;

            packedOrders.forEach(o => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
            <td>${o.order}</td>
            <td>${o.packTime ? o.packTime.toLocaleString() : "-"}</td>
            <td>${o.distributed}</td>
        `;
                table.appendChild(tr);
            });

            packingDiv.appendChild(table);
        }




        // Update KPI cards
        function updateKPIs() {

            let issuedFiltered = [];
            let pendingFiltered = [];

            // ================= PACKING STATION =================
            if (currentWarehouse === "packing") {

                issuedFiltered = issuedOrders.filter(o =>
                    inDateRange(o.packTime)
                );

                pendingFiltered = pendingOrders.filter(o =>
                    inDateRange(o.whTime)
                );

                const total = issuedFiltered.length + pendingFiltered.length;

                document.getElementById("totalOrders").textContent = total;
                document.getElementById("issuedOrders").textContent = issuedFiltered.length;
                document.getElementById("pendingOrders").textContent = pendingFiltered.length;
                document.getElementById("avgPrep").textContent = "0 min";

                return;
            }

            // ================= باقي المستودعات =================
            issuedFiltered = issuedOrders.filter(o =>
                inDateRange(o.packTime)
            );

            pendingFiltered = pendingOrders.filter(o =>
                inDateRange(o.whTime)
            );

            const total = issuedFiltered.length + pendingFiltered.length;
            const issued = issuedFiltered.length;
            const pending = pendingFiltered.length;

            const avgPrep = issued
                ? Math.round(
                    issuedFiltered.reduce((sum, o) => sum + (o.prep || 0), 0) / issued
                )
                : 0;

            document.getElementById("totalOrders").textContent = total;
            document.getElementById("issuedOrders").textContent = issued;
            document.getElementById("pendingOrders").textContent = pending;
            document.getElementById("avgPrep").textContent = avgPrep + " min";
        }

        let dateFilter = { from: null, to: null };

        // Apply manual date filter
        function applyDateFilter() {
            const from = document.getElementById("fromDate").value;
            const to = document.getElementById("toDate").value;

            dateFilter.from = from ? new Date(from + " 00:00:00") : null;
            dateFilter.to = to ? new Date(to + " 23:59:59") : null;

            renderIssuedTable();
            renderPendingTable();
            updateKPIs();
        }

        // Quick buttons
        function quickDate(type) {
            const now = new Date();
            let from = null, to = null;

            if (type === "today") {
                from = new Date(now.setHours(0, 0, 0, 0));
                to = new Date();
            }
            if (type === "yesterday") {
                from = new Date(now.setDate(now.getDate() - 1));
                from.setHours(0, 0, 0, 0);
                to = new Date(from);
                to.setHours(23, 59, 59, 999);
            }
            if (type === "week") {
                const day = now.getDay() || 7;
                from = new Date(now.setDate(now.getDate() - day + 1));
                from.setHours(0, 0, 0, 0);
                to = new Date();
            }
            if (type === "month") {
                from = new Date(now.getFullYear(), now.getMonth(), 1);
                to = new Date();
            }
            if (type === "all") {
                from = null;
                to = null;
            }

            dateFilter.from = from;
            dateFilter.to = to;

            document.getElementById("fromDate").value = from ? from.toISOString().slice(0, 10) : "";
            document.getElementById("toDate").value = to ? to.toISOString().slice(0, 10) : "";

            renderIssuedTable();
            renderPendingTable();
            updateKPIs();
        }

        // Date match helper
        function inDateRange(d) {
            if (!d) return false;
            if (dateFilter.from && d < dateFilter.from) return false;
            if (dateFilter.to && d > dateFilter.to) return false;
            return true;
        }
        function renderPackingTables() {

            const packed = [];
            const waitingPacking = [];
            const waitingOther = [];
const distributed = [];

            allOrders.forEach(o => {

                const whs = o.warehouses;
                const whNames = Object.keys(whs);

                let packedCount = 0;
                const waitingWH = [];

                whNames.forEach(wh => {
                    if (whs[wh].packed) {
                        packedCount++;
                    } else {
                        waitingWH.push(wh);
                    }
                });

                const totalWH = whNames.length;

                // ===== مستودع واحد =====
                if (totalWH === 1) {

                    const w = whs[whNames[0]];

                    if (w.packed) {
                        packed.push({
                            order: o.order,
                            time: w.packTime
                        });
                    } else {
                        waitingPacking.push({
                            order: o.order,
                            time: w.whTime
                        });
                    }

                }

                // ===== أكثر من مستودع =====
                else {

                    if (packedCount === totalWH) {
                        packed.push({
                            order: o.order,
                            time: Object.values(whs).find(w => w.packed)?.packTime
                        });
                    } else {
                        waitingOther.push({
                            order: o.order,
                            waiting: waitingWH.join(", "),
                            time: Object.values(whs).find(w => !w.packed)?.whTime
                        });
                    }

                }

            });

            // ===== Packed =====
            document.getElementById("packedTable").innerHTML = packed.length
                ? `
      <table>
        <tr>
          <th>Order #</th>
          <th>Packed Time</th>
        </tr>
        ${packed.map(o => `
          <tr>
            <td>${o.order}</td>
            <td>${o.time ? o.time.toLocaleString() : "-"}</td>
          </tr>`).join("")}
      </table>`
                : "<p style='color:#aaa'>No packed orders</p>";

            // ===== Waiting Packing =====
            document.getElementById("waitingPackingTable").innerHTML = waitingPacking.length
                ? `
      <table>
        <tr>
          <th>Order #</th>
          <th>Received at WH</th>
        </tr>
        ${waitingPacking.map(o => `
          <tr>
            <td>${o.order}</td>
            <td>${o.time ? o.time.toLocaleString() : "-"}</td>
          </tr>`).join("")}
      </table>`
                : "<p style='color:#aaa'>No waiting packing orders</p>";

            // ===== Waiting Other Warehouse =====
            document.getElementById("waitingOtherTable").innerHTML = waitingOther.length
                ? `
      <table>
        <tr>
          <th>Order #</th>
          <th>Status</th>
        </tr>
        ${waitingOther.map(o => `
          <tr>
            <td>${o.order}</td>
            <td>Waiting other warehouse: <b>${o.waiting}</b></td>
          </tr>`).join("")}
      </table>`
                : "<p style='color:#aaa'>No waiting warehouse orders</p>";
        }

        function toggleQuickMenu() {
            const m = document.getElementById("quickMenu");
            m.style.display = m.style.display === "block" ? "none" : "block";
        }
    </script>

</body>

</html>




