<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Packing Station Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>


  <style>
    :root {
      --bg: #0f172a;
      --sidebar: #020617;
      --card: #111827;
      --accent: #22c55e;
      --warning: #f59e0b;
      --info: #3b82f6;
      --text: #e5e7eb;
      --border: #1f2937;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: Inter, sans-serif;
    }

    body {
      background: var(--bg);
      color: var(--text);
    }

    /* ===== Layout ===== */
    .app {
      display: grid;
      grid-template-columns: 240px 1fr;
      min-height: 100vh;
    }

    aside {
      background: var(--sidebar);
      padding: 20px;
    }

    aside h2 {
      color: var(--accent);
      margin-bottom: 20px;
    }

    aside a {
      color: var(--text);
      text-decoration: none;
      padding: 10px;
      border-radius: 8px;
      display: block;
    }

    aside a:hover,
    aside a.active {
      background: #111827;
      color: var(--accent);
    }

    .container {
      padding: 20px;
    }

    /* ===== KPI ===== */
    .kpis {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .kpi {
      background: #020617;
      padding: 18px;
      border-radius: 14px;
      text-align: center;
    }

    .kpi span {
      font-size: 13px;
      color: #9ca3af;
    }

    .kpi h2 {
      font-size: 28px;
      font-weight: 700;
      margin-top: 6px;
      color: var(--accent);
    }

    /* ===== Sections / Cards ===== */
    .section {
      background: var(--card);
      border-radius: 16px;
      padding: 20px;
    }

    .sections-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
    }

    /* ===== Tables ===== */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }

    th,
    td {
      border: 1px solid #333;
      padding: 8px;
      text-align: center;
    }

    th {
      background: #111827;
      color: var(--accent);
    }

    /* ===== Inputs ===== */
    input {
      width: 100%;
      padding: 8px;
      border-radius: 8px;
      background: #020617;
      border: 1px solid var(--border);
      color: var(--text);
      margin-bottom: 10px;
    }

    input:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* ===== Buttons ===== */
    button {
      background: var(--accent);
      border: none;
      color: #020617;
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }

    button:hover {
      opacity: .85;
    }

    input {
      width: 200px;
    }

    .filters {
      display: flex;
      gap: 16px
    }

    .quick-dates button:hover {
      background: var(--hover);
      color: var(--accent);
    }

    a {
      color: white;
      text-decoration: none;
    }

    #orderDetailsPopup {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    #orderDetailsContent {
      background: var(--card);
      color: var(--text);
      padding: 20px;
      border-radius: 12px;
      width: 500px;
      max-height: 80%;
      overflow-y: auto;
      position: relative;
    }

    #orderDetailsContent button#closePopup {
      position: absolute;
      top: 8px;
      right: 8px;
      background: var(--accent);
      border: none;
      color: #000;
      font-size: 18px;
      cursor: pointer;
      border-radius: 6px;
      width: 32px;
      height: 32px;
    }

    #popupTable {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    #popupTable th,
    #popupTable td {
      border: 1px solid #333;
      padding: 6px 10px;
      text-align: center;
    }

    #popupTable th {
      background: #111827;
      color: var(--accent);
    }

    /* ===== Responsive ===== */
    @media (max-width: 1024px) {
      .app {
        grid-template-columns: 1fr;
      }

      aside {
        position: fixed;
        left: -260px;
        top: 0;
        height: 100vh;
        width: 240px;
        transition: left .3s;
        z-index: 1000;
      }

      aside.open {
        left: 0;
      }
    }
  </style>
</head>

<body>
  <div class="app">



    <aside>
      <h2>Dashboard</h2>
      <nav>
        <a href="index.html">Summary</a>
        <a href="p&c.html">Warehouses</a>
        <a href="packing.html" class="active">Packing Station</a>
      </nav>
    </aside>

    <div class="container">

      <header>
        <h1>Packing Station</h1>
        <div class="filters">
          <input type="date" id="from">
          <input type="date" id="to">


          <div class="quick-dates">
            <button type="button" id="btnToday">today</button>
            <button type="button" id="btnYesterday">yesterday</button>
            <button type="button" id="btnLast7"> last 7 days</button>
          </div>
          <div class="quick-dates">
            <button id="btnRefresh" type="button">Refresh Data</button>
          </div>
        </div>

      </header>

      <div class="kpis">
        <!-- <div class="kpi"><span>Total Orders</span><h2 id="kpiTotal">0</h2></div> -->
        <div class="kpi"><span>In‑Packing Orders</span>
          <h2 id="kpiInPacking">0</h2>
        </div>
        <div class="kpi"><span>Pending (Other WH)</span>
          <h2 id="kpiPending">0</h2>
        </div>
        <a href="#searchDistributed">
          <div class="kpi"> <span>Distributed Orders</span>
            <h2 id="kpiDistributed">0</h2>
          </div>
        </a>


      </div>
      <div class="sections-container">
        <div class="section">
          <h3>In‑Packing Orders</h3>
          <input class="search" id="searchInPacking" placeholder="Search by order or warehouse">
          <table>
            <thead>
              <tr>
                <th>Order</th>
                <th>Received at Packing</th>
                <th>Warehouse</th>
              </tr>
            </thead>
            <tbody id="inPacking"></tbody>
          </table>
          <div style="margin-top:8px;color:var(--muted)">Count: <span id="inPackingCount">0</span></div>
          <button id="seeMoreInPacking">See More</button>
        </div>

        <div class="section">
          <h3>Waiting Other Warehouses</h3>
          <button id="exportWaiting">Export to Excel</button>
          <input class="search" id="searchWaiting" placeholder="Search by order or warehouse">
          <table>
            <thead>
              <tr>
                <th>Order</th>
                <th>Warehouse</th>
                <th>Location</th>
              </tr>
            </thead>
            <tbody id="waiting"></tbody>
          </table>
          <div style="margin-top:8px;color:var(--muted)">Count: <span id="waitingCount">0</span></div>
          <button id="seeMoreWaiting">See More</button>
        </div>

        <div class="section">
          <h3>Distributed Orders</h3>
          <input class="search" id="searchDistributed" placeholder="Search by company">
          <table>
            <thead>
              <tr>
                <th>Company</th>
                <th>Orders</th>
              </tr>
            </thead>
            <tbody id="distributed"></tbody>
          </table>
          <div style="margin-top:8px;color:var(--muted)">Count: <span id="distributedCount">0</span></div>
          <button id="seeMoreDistributed">See More</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Popup / Modal for Order Details -->
  <!-- Popup / Modal for Order Details -->
  <div id="orderDetailsPopup" style="display:none;">
    <div id="orderDetailsContent">
      <button id="closePopup">&times;</button>
      <h3 id="popupTitle">Order Details</h3>
      <table id="popupTable">
        <thead>
          <tr>
            <th>Order</th>
            <th>Time</th>
            <th>Client Address</th>
          </tr>
        </thead>
        <tbody>
          <!-- سيتم ملؤه بالديناميكي -->
        </tbody>
      </table>
    </div>
  </div>

</body>
<script>
  // ==== JavaScript كما في النسخة السابقة مع lazy loading وSee More ====
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSAeWlFZdvqQqrWCq0uJKqxz6boomvVuNal1IYM1tOuoeraNE_ZW2BfYYKr3lKfmldOWOgWAXhz88Ke/pub?gid=457547473&single=true&output=csv";
  const summary = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSAeWlFZdvqQqrWCq0uJKqxz6boomvVuNal1IYM1tOuoeraNE_ZW2BfYYKr3lKfmldOWOgWAXhz88Ke/pub?output=csv"
  const DISTRIBUTION_SHEET = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTecpCEwZ10-Ncz2y0xSsAnNdLXcWDGt_GiAeJlbWYhgg9B8zlhvJ1DeDH8H0NDSg/pub?output=csv";

  let distributionRows = [];

  function setDateRange(fromDate, toDate) {
    const yyyy1 = fromDate.getFullYear();
    const mm1 = String(fromDate.getMonth() + 1).padStart(2, '0');
    const dd1 = String(fromDate.getDate()).padStart(2, '0');

    const yyyy2 = toDate.getFullYear();
    const mm2 = String(toDate.getMonth() + 1).padStart(2, '0');
    const dd2 = String(toDate.getDate()).padStart(2, '0');

    from.value = `${yyyy1}-${mm1}-${dd1}`;
    to.value = `${yyyy2}-${mm2}-${dd2}`;

    apply(); // تحديث الجداول
  }

  // زر "اليوم"
  document.getElementById('btnToday').onclick = () => {
    const today = new Date();
    setDateRange(today, today);
  };

  document.getElementById('btnYesterday').onclick = () => {
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    setDateRange(yesterday, yesterday);
  };


  document.getElementById('btnLast7').onclick = () => {
    const today = new Date();
    const last7 = new Date();
    last7.setDate(today.getDate() - 6);
    setDateRange(last7, today);
  };

  let allRows = [];
  let currentData = { inPacking: [], waiting: [], distributed: [] };
  let limits = { inPacking: 10, waiting: 10, distributed: 10 };

  function parseDate(v) {
    if (!v) return null;
    const parts = v.split(' ')[0].split('/');
    if (parts.length !== 3) return null;
    return new Date(+parts[2], parts[1] - 1, +parts[0]);
  }

  async function fetchCSV() {
    const res = await fetch(CSV_URL);
    const text = await res.text();
    const lines = text.trim().split("\n");
    return lines.slice(1).map(l => {
      const r = l.split(",");
      return {
        order: r[0]?.trim(),
        received: r[1]?.trim(),
        warehouse: r[2]?.trim(),     
        location: r[5]?.trim() || '-',
        comment: r[5]?.trim() || "",
        date: parseDate(r[1])
      };
    }).filter(r => r.order);
  }
function normalizeWarehouseName(name) {
  return name
    .toLowerCase()
    .replace(/---\s*pack/g, '')
    .replace(/\bwh\b/g, '')
    .replace(/\s+/g, ' ')
    .trim();
}



function baseWarehouseName(name) {
  return name
    .toLowerCase()
    .replace(/---\s*pack/g, '')
    .replace(/\bwh\b/g, '')
    .replace(/\s+/g, ' ')
    .trim();
}

function getWaitingOrders(summaryMap, rows, fromDate, toDate) {
  const waitingMap = new Map(); // Map لحفظ كل طلب مرة واحدة

  Object.entries(summaryMap).forEach(([order, info]) => {
    const whMap = new Map();

    [...info.warehouses].forEach(raw => {
      const key = normalizeWarehouseName(raw);
      if (!key) return;

      if (!whMap.has(key)) {
        whMap.set(key, {
          key,
          name: key.toUpperCase(),
          packed: false
        });
      }

      if (/---\s*pack/i.test(raw)) {
        whMap.get(key).packed = true;
      }
    });

    const warehouses = [...whMap.values()];
    if (warehouses.length <= 1) return;

    // فلترة سجلات الطلب حسب التاريخ
    const orderRows = rows.filter(r =>
      r.order === order &&
      r.date &&
      (!fromDate || r.date >= fromDate) &&
      (!toDate || r.date <= toDate)
    );

    if (!orderRows.length) return;

    // تحديث حالة packed من الجدول الفعلي
    orderRows.forEach(r => {
      if (/---\s*pack/i.test(r.warehouse)) {
        const key = normalizeWarehouseName(r.warehouse);
        if (whMap.has(key)) whMap.get(key).packed = true;
      }
    });

    if (warehouses.every(w => w.packed)) return; // إذا كلهم packed لا نضيف

    // دمج الطلب في الخريطة لضمان عدم التكرار
    if (!waitingMap.has(order)) {
      waitingMap.set(order, {
        order,
        warehouses,
        location: orderRows[0].location || '-'
      });
    }
  });

  return Array.from(waitingMap.values());
}

    
   
    
   

  
function classify(rows, summaryMap, distributionRows, fromDate, toDate) {

  /* =========================
     Distributed Orders
  ========================= */
  const distributed = [];
  const seenDistributed = new Set();

  distributionRows.forEach(d => {
    if (!seenDistributed.has(d.order)) {
      distributed.push({
        order: d.order,
        company: d.company?.toUpperCase() || '',
        time: d.time,
        clientAddress: d.clientAddress,
        date: d.date
      });
      seenDistributed.add(d.order);
    }
  });


  /* =========================
     In-Packing (تجميع المستودعات)
  ========================= */
  const inPackingMap = {};

  rows.forEach(r => {
    if (seenDistributed.has(r.order)) return;
    if (!r.received) return;

    if (!inPackingMap[r.order]) {
      inPackingMap[r.order] = {
        order: r.order,
        received: r.received,
        warehouses: new Set()
      };
    }

    // تنظيف اسم المستودع وإزالة ---Pack
    const cleanWH = r.warehouse
      ? r.warehouse.replace(/---\s*pack/i, '').trim()
      : '';

    if (cleanWH) {
      inPackingMap[r.order].warehouses.add(cleanWH);
    }
  });

  const inPacking = Object.values(inPackingMap).map(o => ({
    order: o.order,
    received: o.received,
    warehouse: Array.from(o.warehouses).join(' , ')
  }));


  /* =========================
     Waiting Other Warehouses
  ========================= */
  const waiting = getWaitingOrders(summaryMap, rows, fromDate, toDate);


  return { inPacking, waiting, distributed };
}



  function render(data) {
    currentData = data;

    document.getElementById('kpiInPacking').textContent =
      data.inPacking.length;

    document.getElementById('kpiPending').textContent =
      data.waiting.length;

    document.getElementById('kpiDistributed').textContent =
      data.distributed.length;

    renderTables();
  }
function displayWarehouse(name) {
  return name ? name.replace(/---\s*pack/i, '').trim() : '';
}

  function renderTables() {
    const s1 = searchInPacking.value.toLowerCase();
    const s2 = searchWaiting.value.toLowerCase();
    const s3 = searchDistributed.value.toLowerCase().trim();

    /* ===============================
       In-Packing
    =============================== */
    const inP = currentData.inPacking.filter(r =>
      r.order.toLowerCase().includes(s1) ||
      r.warehouse.toLowerCase().includes(s1)
    );

    inPacking.innerHTML = inP.slice(0, limits.inPacking)
      .map(r => `
      <tr>
        <td>${r.order}</td>
        <td>${r.received}</td>
       <td>${displayWarehouse(r.warehouse)}</td>
      </tr>
    `)
      .join('');

    document.getElementById('inPackingCount').textContent = inP.length;


    /* ===============================
       Waiting Other Warehouses
    =============================== */
    const wait = currentData.waiting.filter(r =>
      r.order.toLowerCase().includes(s2) ||
      r.warehouses.toLowerCase().includes(s2)
    );

   waiting.innerHTML = wait.slice(0, limits.waiting)
  .map(r => `
    <tr>
      <td>${r.order}</td>
      <td>
        ${r.warehouses.map(w => `
          <span style="
            display:inline-block;
            margin:2px;
            padding:4px 8px;
            border-radius:6px;
            font-size:12px;
            font-weight:600;
            background:${w.packed ? '#22c55e' : '#7c2d12'};
            color:${w.packed ? '#000' : '#f59e0b'};
          ">
            ${w.name}
          </span>
        `).join('')}
      </td>
      <td>${r.location}</td>
    </tr>
  `)
  .join('');

    document.getElementById('waitingCount').textContent = wait.length;


    /* ===============================
       Distributed Orders
    =============================== */
    const map = {};
    currentData.distributed.forEach(r => {
      if (!map[r.company]) map[r.company] = [];
      map[r.company].push(r);
    });

    const companies = Object.keys(map).filter(company => {
      if (!s3) return true;

      if (company.toLowerCase().includes(s3)) return true;

      return map[company].some(o =>
        o.order && o.order.toLowerCase().includes(s3)
      );
    });

    distributed.innerHTML = companies.slice(0, limits.distributed).map(company => {

      const orders = map[company];

      // ترتيب حسب الوقت
      const sortedOrders = orders.slice().sort((a, b) => {
        const [hA, mA] = (a.time || '00:00').split(':').map(Number);
        const [hB, mB] = (b.time || '00:00').split(':').map(Number);
        return (hA * 60 + mA) - (hB * 60 + mB);
      });




      return `
      <tr>
        <td>${company}</td>
        <td><a href="#" class="show-details" data-company="${company}"> ${sortedOrders.length} </a></td>
      </tr>
    `;
    }).join('');

    document.getElementById('distributedCount').textContent = companies.length;

    // ربط حدث البوب أب بعد التوليد
    document.querySelectorAll('#distributed .show-details').forEach(el => {
      el.onclick = e => {
        e.preventDefault();
        const company = el.dataset.company;
        const orders = currentData.distributed.filter(o => o.company === company);
        showOrdersDetails(company, orders);
      };
    });

    /* ===============================
       See More buttons
    =============================== */
    seeMoreInPacking.style.display =
      inP.length > limits.inPacking ? 'inline-block' : 'none';

    seeMoreWaiting.style.display =
      wait.length > limits.waiting ? 'inline-block' : 'none';

    seeMoreDistributed.style.display =
      companies.length > limits.distributed ? 'inline-block' : 'none';
  }

  // ==============================
  // تحديث البوب أب لإظهار عمود الوقت
  // ==============================
  function showOrdersDetails(company, detailsArray) {
    const popup = document.getElementById('orderDetailsPopup');
    const title = document.getElementById('popupTitle');
    const tbody = document.querySelector('#popupTable tbody');

    title.textContent = `Order Details for ${company}`;
    tbody.innerHTML = ''; // مسح أي بيانات سابقة

    detailsArray.forEach(o => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
  <td>${o.order}</td>
  <td>${o.time || '-'}</td>
  <td>${o.clientAddress || '-'}</td>
`;

      tbody.appendChild(tr);
    });

    popup.style.display = 'flex';
  }

  seeMoreInPacking.onclick = () => { limits.inPacking += 7; renderTables(); };
  seeMoreWaiting.onclick = () => { limits.waiting += 7; renderTables(); };
  seeMoreDistributed.onclick = () => { limits.distributed += 7; renderTables(); };

function setToday() {
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, '0');
  const dd = String(today.getDate()).padStart(2, '0');

  from.value = `${yyyy}-${mm}-${dd}`;
  to.value = `${yyyy}-${mm}-${dd}`;
}


  // function applyDateFilter(){
  //  let filtered = [...allRows];
  //  const fromVal = from.value;
  //  const toVal = to.value;
  //  if(fromVal){ const f = new Date(fromVal); filtered = filtered.filter(r=>r.date && r.date >= f);}
  //  if(toVal){ const t = new Date(toVal); t.setHours(23,59,59,999); filtered = filtered.filter(r=>r.date && r.date <= t);}
  //  render(classify(filtered));
  // }

  // [from,to,searchInPacking,searchWaiting,searchDistributed].forEach(el=>{
  //  el.addEventListener('input',()=>{
  //    if(el===from||el===to) applyDateFilter(); else renderTables();
  //  });
  // });
  // 

 async function fetchSummary() {
  const res = await fetch(summary);
  const text = await res.text();
  const lines = text.trim().split("\n");

  return lines.slice(1).map(l => {
    const r = l.split(",");
    return {
      order: r[0]?.trim(),
      warehouse: r[2]?.trim(),
      receivedDate: r[1]?.trim(), // Order Received in WH
      date: parseAnyDate(r[1])   // تحويل التاريخ لدالة Date
    };
  }).filter(r => r.order && r.warehouse && r.date);
}

function analyzeOrders(summaryRows) {
  const map = {};

  summaryRows.forEach(r => {
    if (!map[r.order]) {
      map[r.order] = {
        warehouses: new Set(),
        dates: []   // ⬅️ خزن التواريخ
      };
    }

    map[r.order].warehouses.add(r.warehouse.trim());
    if (r.date) map[r.order].dates.push(r.date);
  });

  return map;
}

async function init() {
  allRows = await fetchCSV();
  const summaryRows = await fetchSummary();
  summaryMap = analyzeOrders(summaryRows);
  distributionRows = await fetchDistribution();

  // ضع التاريخ اليوم تلقائياً
  setToday();

  // الاستماع للتغييرات
  from.oninput = apply;
  to.oninput = apply;
  searchInPacking.oninput = renderTables;
  searchWaiting.oninput = renderTables;
  searchDistributed.oninput = renderTables;

  apply(); // ← تطبيق الفلاتر بعد تحميل البيانات
}


function apply() {
  const f = from.value ? new Date(from.value) : null;
  if (f) f.setHours(0,0,0,0);
  const t = to.value ? new Date(to.value) : null;
  if (t) t.setHours(23,59,59,999);

  const filteredRows = allRows.filter(r => {
    if (!r.date) return false;
    if (f && r.date < f) return false;
    if (t && r.date > t) return false;
    return true;
  });

  const filteredDistribution = distributionRows.filter(r => {
    if (!r.date) return false;
    if (f && r.date < f) return false;
    if (t && r.date > t) return false;
    return true;
  });

  render(classify(filteredRows, summaryMap, filteredDistribution, f, t));
}

  document.getElementById('btnRefresh').onclick = async () => {
    // يمكن تعطيل الزر أثناء التحميل لتفادي الضغط المتكرر
    const btn = document.getElementById('btnRefresh');
    btn.disabled = true;
    btn.textContent = 'Refreshing...';

    try {
      await init();  // إعادة تحميل البيانات وتحديث الواجهة
    } catch (e) {
      console.error('Error refreshing data:', e);
      alert('Failed to refresh data.');
    } finally {
      btn.disabled = false;
      btn.textContent = 'Refresh Data';
    }
  };










  function parseAnyDate(v) {
    if (!v) return null;
    v = v.trim();

    // DD/MM/YYYY أو DD-MM-YYYY مع أو بدون وقت
    let m = v.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})(?:\s+(\d{1,2}):(\d{1,2})(?::(\d{1,2}))?)?/);
    if (m) {
      const day = +m[1], month = +m[2] - 1, year = +m[3];
      const hour = +m[4] || 0, min = +m[5] || 0, sec = +m[6] || 0;
      return new Date(year, month, day, hour, min, sec);
    }

    // YYYY-MM-DD مع أو بدون وقت
    m = v.match(/^(\d{4})-(\d{1,2})-(\d{1,2})(?:\s+(\d{1,2}):(\d{1,2})(?::(\d{1,2}))?)?/);
    if (m) {
      const year = +m[1], month = +m[2] - 1, day = +m[3];
      const hour = +m[4] || 0, min = +m[5] || 0, sec = +m[6] || 0;
      return new Date(year, month, day, hour, min, sec);
    }

    // fallback
    const d = new Date(v);
    return isNaN(d) ? null : d;
  }




  async function fetchDistribution() {
    const res = await fetch(DISTRIBUTION_SHEET);
    const text = await res.text();

    const parsed = Papa.parse(text, {
      delimiter: ",",
      skipEmptyLines: true,
    });

    // Ignore header if موجود (عادة أول سطر فيه عنوان الأعمدة)
    let data = parsed.data;
    if (data.length && data[0][0].toLowerCase().includes("request number")) {
      data = data.slice(1);
    }

    return data.map(r => ({
      order: r[0] || null,
      rawDate: r[1] || null,
      date: parseAnyDate(r[1]),
      clientAddress: r[2] || '-',
      time: r[3] || '-',
      company: r[4] || null
    })).filter(r => r.order && r.company);
  }

  function showOrdersDetails(company, detailsArray) {
    const popup = document.getElementById('orderDetailsPopup');
    const title = document.getElementById('popupTitle');
    const tbody = document.querySelector('#popupTable tbody');

    title.textContent = `Order Details for ${company}`;
    tbody.innerHTML = ''; // مسح أي بيانات 

    detailsArray.forEach(o => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
    <td>${o.order}</td>
    <td>${o.time || '-'}</td>   <!-- حرف صغير -->
    <td>${o.clientAddress || '-'}</td>
  `;
      tbody.appendChild(tr);
    });


    popup.style.display = 'flex';
  }

  // زر إغلاق البوب أب
  document.getElementById('closePopup').onclick = () => {
    document.getElementById('orderDetailsPopup').style.display = 'none';
  }

  // إغلاق عند الضغط خارج المحتوى
  document.getElementById('orderDetailsPopup').onclick = e => {
    if (e.target.id === 'orderDetailsPopup') {
      document.getElementById('orderDetailsPopup').style.display = 'none';
    }
  }
document.getElementById('exportWaiting').onclick = () => {
  const wait = currentData.waiting;

  // تجهيز البيانات للـ CSV
  const csvData = wait.map(r => ({
    Order: r.order,
    Warehouses: r.warehouses.map(w => `${w.name} (${w.packed ? 'Packed' : 'Pending'})`).join(' , '),
    Location: r.location
  }));

  // تحويل JSON إلى CSV باستخدام PapaParse
  const csv = Papa.unparse(csvData);

  // إنشاء رابط تحميل مؤقت
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `Waiting_Other_Warehouses_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
};

  function parseDistributionDate(v) {
    if (!v) return null;
    const d = new Date(v);
    return isNaN(d) ? null : d;
  }

  console.table(distributionRows);
  init();

</script>

            </html>
